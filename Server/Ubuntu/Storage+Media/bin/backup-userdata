#!/usr/bin/env bash

_script_name="userdata-backup"

_tmp_log="$(mktemp)"
_log_file="/var/log/borg/${_script_name}.log"

_email_address="bradfrank@fastmail.com"
_borg_passphrase="$(</root/.borg-userdata)"

export BORG_REPO="nas:/volume1/BorgBackups/nas0/userdata"
export BORG_PASSPHRASE="$_borg_passphrase"


info() {
  logger -t "$_script_name" "$*"
}

fail_and_exit() {
  info "$*"
  send_email "$_script_name failed"
  save_log
  exit 1
}

send_email() {
  # Set email subject line
  local _email_header
  _email_header=$(printf "%s\n" "Subject: $1")

  # Combine subject + body
  local _email_body
  _email_body="$(mktemp)"
  printf '%s\n\n%s' "$_email_header" "$(<"$_tmp_log")" > "$_email_body"

  # Send email with ssmtp
  ssmtp "$_email_address" < "$_email_body"

  # cleanup
  rm "$_email_body"
}

save_log() {
  # Add a blank line for readability
  printf '\n' >> "$_log_file"

  # Append this backup log to main log file
  cat "$_tmp_log" >> "$_log_file"

  # Remove temporary log file
  rm "$_tmp_log"
}


[[ ! -f "$_log_file" ]] && touch "$_log_file"

# Backup plex application and user data
info "Performing backup..."
borg create                           \
    --verbose                         \
    --filter AME                      \
    --list                            \
    --stats                           \
    --show-rc                         \
    --compression lz4                 \
    --exclude-caches                  \
    --remote-path /usr/local/bin/borg \
    ::'{now}'                         \
    /nas0/userdata                    \
    >> "$_tmp_log" 2>&1
_backup_exit=$?

# Check that backup finished successfully
if [[ "$_backup_exit" -gt 0 ]]; then
  fail_and_exit "Error: backup failed"
fi

# Add a blank line for readability
printf '\n' >> "$_tmp_log"

# Prune to maintain 7 daily, 4 weekly, and 6 monthly backup archives
info "Pruning old backups..."
borg prune                            \
    --list                            \
    --show-rc                         \
    --keep-daily    7                 \
    --keep-weekly   4                 \
    --keep-monthly  6                 \
    --remote-path /usr/local/bin/borg \
    >> "$_tmp_log" 2>&1
_prune_exit=$?

# Check that pruning finished successfully
if [[ "$_prune_exit" -gt 0 ]]; then
  fail_and_exit "Error: pruning failed"
fi

# End of script - email and quit
info "Backup script completed."
send_email "$_script_name completed"
save_log

exit 0
