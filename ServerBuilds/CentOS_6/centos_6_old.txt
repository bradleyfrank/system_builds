INSTALLATION

Making install media: http://red.ht/Oz9tr9
Media downloads: http://mirrors.seas.harvard.edu/centos/6/isos/
Disk partitioning: http://red.ht/Oz9Em7

Partition your drive as needed, or use one of the default settings. Select "Minimal" and then select "Customize now". Under "Base" select all packages in the "Base" sub-category.


SYSTEM CONFIGURATION

Connecting to the Network

Consistent network device naming: http://red.ht/UDhcb4
Ethernet interfaces: http://red.ht/142Y4ZI
Configuration of /etc/sysconfig/network: http://red.ht/VsLopY

Run ifconfig to find the network device name and MAC address. Use the MAC address to give your server a static IP address in order to setup port forwarding on your router (port 80 is for web traffic, and port 443 is for SSL/HTTPS). Make the following changes to your network device configuration file, substituting your own network information.

/etc/sysconfig/network-scripts/ifcfg-[device]
DEVICE="[device]"
BOOTPROTO="none"
ONBOOT="yes
NETMASK="255.255.255.0"
IPADDR="10.0.1.27"
USERCTL="no"

/etc/resolv.conf
search [domain.tld]
nameserver [DNS address]
nameserver [DNS address]

/etc/sysconfig/network
NETWORKING=yes
HOSTNAME=[hostname].[domain.tld]
GATEWAY=[Gateway]

# echo "[IP Address] [hostname].[domain.tld] [hostname]" >> /etc/hosts
# service network restart


Adding Users

groupadd webadmin
useradd -G webadmin [username]
passwd [username]

# visudo
root		ALL=(ALL)	ALL
[username]	ALL=(ALL)	ALL

# yum install acl

/etc/fstab
root / ext4 defaults,acl 1 1


A Note on Runlevels

Enterprise Linux runlevels: http://red.ht/RzdpNf

chkconfig is used to start programs at boot. Use the following command to verify at what runlevels an individual program starts: chkconfig [service] --list.


Syncing the System Clock

# chkconfig ntpd on
# ntpdate pool.ntp.org
# service ntpd start


Adding Repositories and Updating the System

Extra Packages for Enterprise Linux: https://fedoraproject.org/wiki/About_EPEL
Les RPM de Remi: http://blog.famillecollet.com/pages/English-site-introduction
What is MariaDB 5.5: https://kb.askmonty.org/en/what-is-mariadb-55/
Setting up MariaDB Repositories: https://downloads.mariadb.org/mariadb/repositories/

# rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6
# rpm --import https://fedoraproject.org/static/0608B895.txt
# rpm --import http://rpms.famillecollet.com/RPM-GPG-KEY-remi
# rpm --import https://yum.mariadb.org/RPM-GPG-KEY-MariaDB

# rpm -ivh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
rpm -ivh http://dl.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm
# rpm -ivh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm
# touch /etc/yum.repos.d/MariaDB.repo

/etc/yum.repos.d/MariaDB.repo
[mariadb]
name = MariaDB
baseurl = http://yum.mariadb.org/5.5/centos6-x86
gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB
gpgcheck=1

We want PHP packages from Remi, not CentOS, so we'll make changes to reflect that.

/etc/yum.repos.d/CentOS-Base.repo
[base]
name=CentOS-$releasever - Base
mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=os
#baseurl=http://mirror.centos.org/centos/$releasever/os/$basearch/
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6
exclude=php* mysql*

#released updates 
[updates]
name=CentOS-$releasever - Updates
mirrorlist=http://mirrorlist.centos.org/?release=$releasever&arch=$basearch&repo=updates
#baseurl=http://mirror.centos.org/centos/$releasever/updates/$basearch/
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6
exclude=php* mysql*

Enable the Remi repo, as it comes disabled by default.

/etc/yum.repos.d/remi.repo
[remi]
name=Les RPM de remi pour Enterprise Linux $releasever - $basearch
#baseurl=http://rpms.famillecollet.com/enterprise/$releasever/remi/$basearch/
mirrorlist=http://rpms.famillecollet.com/enterprise/$releasever/remi/mirror
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-remi
failovermethod=priority
includepkgs=php*

# yum update


Configuring SSH

/etc/ssh/sshd_config
Port [custom port]
PermitRootLogin no


Configuring Firewall

IPTables: http://wiki.centos.org/HowTos/Network/IPTables

# iptables -P INPUT ACCEPT
# iptables -F
# iptables -A INPUT -i lo -j ACCEPT
# iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
# iptables -A INPUT -p tcp --dport [custom port] -j ACCEPT
# iptables -A INPUT -p tcp --dport 80 -j ACCEPT
# iptables -A INPUT -p tcp --dport 443 -j ACCEPT
# iptables -P INPUT DROP
# iptables -P FORWARD DROP
# iptables -P OUTPUT ACCEPT
# service iptables save


Install Apache

The robots.txt file: http://www.robotstxt.org/robotstxt.html

You can access your site at http://www.[domain.tld]; if Apache is running, you'll see the default Apache landing page. If you prefer a blank page:
	# touch /var/www/html/index.html
Now that Apache has created a root web folder, we need to give the webadmin group access to read, write and modify that directory (i.e. so you can use SFTP to upload files).

# yum install httpd
# chkconfig httpd on
# service httpd start
# touch /var/www/html/robots.txt
# wget -P /var/www/html http://www.sourceopen.com/favicon.ico
# mkdir /var/log/httpd/archive
# setfacl -m g:[groupname]:rwx /var/www/html/


Install PHP

# yum install php php-gd php-mbstring php-mcrypt php-xml php-pspell php-mysqlnd
# touch /var/log/httpd/php_error_log
# setfacl -m u:apache:rw /var/log/httpd/php_error_log
# cp /etc/php.ini /etc/php.ini.default

/etc/php.ini
disable_functions = show_source, system, shell_exec, passthru, exec, phpinfo, proc_open, proc_nice
expose_php = Off
error_reporting = E_ALL & ~E_DEPRECATED
display_errors = Off
log_errors = On
error_log = /var/log/httpd/php_error_log
enable_dl = Off
allow_url_* = Off
date.timezone = [timezone]


Installing MySQL

# yum install MariaDB-server MariaDB-client
# chkconfig mysql on
# service mysql start
# mysql_secure_installation
	- Enter current password for root (enter for none): [enter]
	- Set root password? [Y/n] Y
	- Remove anonymous users? [Y/n] Y
	- Disallow root login remotely? [Y/n] Y
	- Remove test database and access to it? [Y/n] Y
	- Reload privilege tables now? [Y/n] Y

# yum install phpMyAdmin

/etc/httpd/conf.d/phpMyAdmin.conf
Alias /maria /usr/share/phpMyAdmin

<Directory /usr/share/phpMyAdmin/>
   <IfModule mod_authz_core.c>
     # Apache 2.4
     Require local
   </IfModule>
   <IfModule !mod_authz_core.c>
     # Apache 2.2
     Order Deny,Allow
     Deny from All
     Allow from [private/public ip]
     Allow from 127.0.0.1
     Allow from ::1
   </IfModule>
</Directory>

# mysql -u root -p
mysql> source /usr/share/phpMyAdmin/examples/create_tables.sql
mysql> GRANT USAGE ON mysql.* TO '[control user]'@'localhost' IDENTIFIED BY '[password]';
mysql> GRANT SELECT (
	Host, User, Select_priv, Insert_priv, Update_priv, Delete_priv,
	Create_priv, Drop_priv, Reload_priv, Shutdown_priv, Process_priv,
	File_priv, Grant_priv, References_priv, Index_priv, Alter_priv,
	Show_db_priv, Super_priv, Create_tmp_table_priv, Lock_tables_priv,
	Execute_priv, Repl_slave_priv, Repl_client_priv
	) ON mysql.user TO '[control user]'@'localhost';
mysql> GRANT SELECT ON mysql.db TO '[control user]'@'localhost';
mysql> GRANT SELECT ON mysql.host TO '[control user]'@'localhost';
mysql> GRANT SELECT (Host, Db, User, Table_name, Table_priv, Column_priv) ON mysql.tables_priv TO '[control user]'@'localhost';
mysql> GRANT SELECT, INSERT, UPDATE, DELETE ON phpmyadmin.* TO '[control user]'@'localhost';
mysql> quit

http://www.question-defense.com/tools/phpmyadmin-blowfish-secret-generator

/etc/phpMyAdmin/config.inc.php
$cfg['blowfish_secret'] = '[passphrase]';

/* User used to manipulate with storage */
// $cfg['Servers'][$i]['controlhost'] = '';
$cfg['Servers'][$i]['controluser'] = '[control user]';
$cfg['Servers'][$i]['controlpass'] = '[password]';

/* Storage database and tables */
$cfg['Servers'][$i]['pmadb'] = 'phpmyadmin';
$cfg['Servers'][$i]['bookmarktable'] = 'pma_bookmark';
$cfg['Servers'][$i]['relation'] = 'pma_relation';
$cfg['Servers'][$i]['table_info'] = 'pma_table_info';
$cfg['Servers'][$i]['table_coords'] = 'pma_table_coords';
$cfg['Servers'][$i]['pdf_pages'] = 'pma_pdf_pages';
$cfg['Servers'][$i]['column_info'] = 'pma_column_info';
$cfg['Servers'][$i]['history'] = 'pma_history';
$cfg['Servers'][$i]['tracking'] = 'pma_tracking';
$cfg['Servers'][$i]['designer_coords'] = 'pma_designer_coords';
$cfg['Servers'][$i]['userconfig'] = 'pma_userconfig';


# yum install awstats
# cp /etc/awstats/awstats.localhost.localdomain.conf /etc/awstats/awstats.www.[domain.tld].conf

/etc/awstats/awstats.www.[domain.tld].conf
SiteDomain="[domain.tld]"
HostAliases="[domain.tld] localhost 127.0.0.1 REGEX[^.*[domain.tld]$]"
BuildReportFormat=xhtml

/etc/httpd/conf.d/awstats.conf
<Directory "/usr/share/awstats/wwwroot">
    Options None
    AllowOverride None
    Order deny,allow
    Deny from all
    Allow from [private/public ip]
    Allow from 127.0.0.1
</Directory>

/etc/logrotate.d/httpd
/var/log/httpd/*log {
    missingok
    notifempty
    daily
    rotate 7
    olddir /var/log/httpd/archive
    sharedscripts
    prerotate
        /usr/share/awstats/wwwroot/cgi-bin/awstats.pl -update -config=www.[domain.tld]
    endscript
    postrotate
        /sbin/service httpd reload > /dev/null 2>/dev/null || true
    endscript
}

# /usr/share/awstats/wwwroot/cgi-bin/awstats.pl -update -config=www.[domain.tld]
# service httpd restart

http://www.[domain.tld]/awstats/awstats.pl?config=www.[domain.tld]